unit uClientes;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, Grids, DBGrids, ExtCtrls, Buttons, StdCtrls, Menus;

type
  TfrmClientes = class(TForm)
    Panel1: TPanel;
    DBGrid1: TDBGrid;
    Panel2: TPanel;
    btnInserir: TSpeedButton;
    btnEditar: TSpeedButton;
    lbl1: TLabel;
    edtBuscar: TEdit;
    Panel3: TPanel;
    btnSair: TSpeedButton;
    btnExcluir: TSpeedButton;
    btnBuscarCNPJ: TSpeedButton;
    PopUp1: TPopupMenu;
    I1: TMenuItem;
    E1: TMenuItem;
    E2: TMenuItem;
    B1: TMenuItem;
    S1: TMenuItem;
    btn1: TSpeedButton;
    procedure btnSairClick(Sender: TObject);
    procedure DBGrid1DrawColumnCell(Sender: TObject; const Rect: TRect;
      DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure FormShow(Sender: TObject);
    procedure edtBuscarEnter(Sender: TObject);
    procedure edtBuscarExit(Sender: TObject);
    procedure edtBuscarChange(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure edtBuscarKeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure DBGrid1DblClick(Sender: TObject);
    procedure DBGrid1KeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure btnInserirClick(Sender: TObject);
    procedure btnEditarClick(Sender: TObject);
    procedure btnBuscarCNPJClick(Sender: TObject);
    procedure btnExcluirClick(Sender: TObject);
    procedure I1Click(Sender: TObject);
    procedure E1Click(Sender: TObject);
    procedure E2Click(Sender: TObject);
    procedure B1Click(Sender: TObject);
    procedure S1Click(Sender: TObject);
    procedure btn1Click(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  frmClientes: TfrmClientes;
  FNovoCadastro: Boolean;

implementation

uses uDM, uClienteEditar, uBuscaCNPJ, uMenu;

{$R *.dfm}

procedure TfrmClientes.btnSairClick(Sender: TObject);
begin
  Close;
end;

procedure TfrmClientes.DBGrid1DrawColumnCell(Sender: TObject;
  const Rect: TRect; DataCol: Integer; Column: TColumn;
  State: TGridDrawState);
begin
  if(FConexao = 'Zeos')then
  begin
    if not odd(DM.TCliente.RecNo) then
    begin
      if not (gdSelected in State) then
      begin
         DBGrid1.Canvas.Brush.Color := TColor($FFEFE0);
         DBGrid1.Canvas.FillRect(Rect);
         DBGrid1.DefaultDrawDataCell(rect,Column.Field,state);
      end;
    end;
  end else
  begin
    if not odd(DM.TBCliente.RecNo) then
    begin
      if not (gdSelected in State) then
      begin
         DBGrid1.Canvas.Brush.Color := TColor($FFEFE0);
         DBGrid1.Canvas.FillRect(Rect);
         DBGrid1.DefaultDrawDataCell(rect,Column.Field,state);
      end;
    end;
  end;
end;

procedure TfrmClientes.FormShow(Sender: TObject);
begin
  DM.TBCliente.Open;
  DM.TBCliente.RecordCount;
end;

procedure TfrmClientes.edtBuscarEnter(Sender: TObject);
begin
  edtBuscar.Color := clInfoBk;
end;

procedure TfrmClientes.edtBuscarExit(Sender: TObject);
begin
  edtBuscar.Color := clWhite;
end;

procedure TfrmClientes.edtBuscarChange(Sender: TObject);
var
  lFiltro: String;
begin
  if(FConexao = 'Zeos')then
  begin
    DM.TCliente.Filtered := false;
    DM.TCliente.Filter :=  'NOME LIKE '+QuotedStr('*'+LowerCase(edtBuscar.Text)+'*');
    DM.TCliente.Filtered := true;
    if(DM.TCliente.RecordCount = 0)then
    begin
      DM.TCliente.Filtered := false;
      DM.TCliente.Filter := 'LOWER(DOCUMENTO) LIKE '+QuotedStr('%'+LowerCase(edtBuscar.Text)+'%');
      DM.TCliente.Filtered := true;
    end;
    if(DM.TCliente.RecordCount = 0)then
    begin
      DM.TCliente.Filtered := false;
      DM.TCliente.Filter := 'LOWER(EMAIL) LIKE '+QuotedStr('%'+LowerCase(edtBuscar.Text)+'%');
      DM.TCliente.Filtered := true;
    end;
    if(DM.TCliente.RecordCount = 0)then
    begin
      DM.TCliente.Filtered := false;
      DM.TCliente.Filter := 'LOWER(TELEFONE) LIKE '+QuotedStr('%'+LowerCase(edtBuscar.Text)+'%');
      DM.TCliente.Filtered := true;
    end;
  end else
  begin
    DM.TBCliente.Filtered := false;
    DM.TBCliente.Filter := 'LOWER(NOME) LIKE '+QuotedStr('%'+LowerCase(edtBuscar.Text)+'%');
    DM.TBCliente.Filtered := true;
    if(DM.TBCliente.RecordCount = 0)then
    begin
      DM.TBCliente.Filtered := false;
      DM.TBCliente.Filter := 'LOWER(DOCUMENTO) LIKE '+QuotedStr('%'+LowerCase(edtBuscar.Text)+'%');
      DM.TBCliente.Filtered := true;
    end;
    if(DM.TBCliente.RecordCount = 0)then
    begin
      DM.TBCliente.Filtered := false;
      DM.TBCliente.Filter := 'LOWER(EMAIL) LIKE '+QuotedStr('%'+LowerCase(edtBuscar.Text)+'%');
      DM.TBCliente.Filtered := true;
    end;
    if(DM.TBCliente.RecordCount = 0)then
    begin
      DM.TBCliente.Filtered := false;
      DM.TBCliente.Filter := 'LOWER(TELEFONE) LIKE '+QuotedStr('%'+LowerCase(edtBuscar.Text)+'%');
      DM.TBCliente.Filtered := true;
    end;
  end;
end;

procedure TfrmClientes.FormClose(Sender: TObject;
  var Action: TCloseAction);
begin
  DM.TBCliente.Filtered := false;
end;

procedure TfrmClientes.edtBuscarKeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  if(key = vk_return)then
    DBGrid1.SetFocus;
end;

procedure TfrmClientes.DBGrid1DblClick(Sender: TObject);
begin
  if(btnEditar.Enabled)then
    btnEditar.Click;
end;

procedure TfrmClientes.DBGrid1KeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  if(key = vk_return)then
  begin
    if(btnEditar.Enabled)then
      btnEditar.Click;
  end;
end;

procedure TfrmClientes.btnInserirClick(Sender: TObject);
begin
  if(FConexao = 'Zeos')then
  begin
    DM.TCliente.Filtered := false;
    DM.TCliente.Insert;
  end else
  begin
    DM.TBCliente.Filtered := false;
    DM.TBCliente.Insert;
  end;

  frmClienteEditar := TfrmClienteEditar.Create(Self);
  frmClienteEditar.ShowModal;

  if(FConexao = 'Zeos')then
  begin
    DM.TCliente.Refresh;
  end else
  begin
    DM.TBCliente.Refresh;
  end;
end;

procedure TfrmClientes.btnEditarClick(Sender: TObject);
var
  lClienteEditado: Integer;
begin
  if(FConexao = 'Zeos')then
  begin
    lClienteEditado := DM.TClienteID.Value;
    DM.TCliente.Filtered := false;
    if(DM.TCliente.Locate('ID',lClienteEditado,[]))then
    begin
      DM.TCliente.Edit;
      frmClienteEditar := TfrmClienteEditar.Create(Self);
      frmClienteEditar.ShowModal;
    end;
  end else
  begin
    lClienteEditado := DM.TBClienteID.Value;
    DM.TBCliente.Filtered := false;
    if(DM.TBCliente.Locate('ID',lClienteEditado,[]))then
    begin
      DM.TBCliente.Edit;
      frmClienteEditar := TfrmClienteEditar.Create(Self);
      frmClienteEditar.ShowModal;
    end;
  end;
end;

procedure TfrmClientes.btnBuscarCNPJClick(Sender: TObject);
begin
  frmBuscaCNPJ := TfrmBuscaCNPJ.Create(Self);
  frmBuscaCNPJ.ShowModal;
end;

procedure TfrmClientes.btnExcluirClick(Sender: TObject);
begin
  if(Application.MessageBox('Você realmente deseja excluir o cliente?','Atenção',MB_ICONQUESTION + MB_YESNO)=mrYes)then
  begin
    if(FConexao = 'Zeos')then
    begin
      DM.QVerificar.Close;
      DM.QVerificar.SQL.Clear;
      DM.QVerificar.SQL.Add('SELECT COUNT(*) AS QUANTIDADE FROM ORDEM_SERVICO WHERE CLIENTE_ID = :pCliente');
      DM.QVerificar.Params.ParamByName('pCliente').AsInteger := DM.TBClienteID.Value;
      DM.QVerificar.Open;
      if(DM.QVerificar.Fields.FieldByName('QUANTIDADE').AsInteger > 0)then
      begin
        ShowMessage('Este cliente já tem ordens de serviço lançadas em seu nome, não é possível excluí-lo sem antes excluir suas ordens de serviço!');
        Abort;
      end;
      DM.TCliente.Delete;
      DM.TCliente.ApplyUpdates;
    end else
    begin
      DM.QueryVerificar.Close;
      DM.QueryVerificar.SQL.Clear;
      DM.QueryVerificar.SQL.Add('SELECT COUNT(*) AS QUANTIDADE FROM ORDEM_SERVICO WHERE CLIENTE_ID = :pCliente');
      DM.QueryVerificar.Params.ParamByName('pCliente').AsInteger := DM.TBClienteID.Value;
      DM.QueryVerificar.Open;
      if(DM.QueryVerificar.Fields.FieldByName('QUANTIDADE').AsInteger > 0)then
      begin
        ShowMessage('Este cliente já tem ordens de serviço lançadas em seu nome, não é possível excluí-lo sem antes excluir suas ordens de serviço!');
        Abort;
      end;
      DM.TBCliente.Delete;
      DM.TBCliente.ApplyUpdates(0);
    end;
  end;
end;

procedure TfrmClientes.I1Click(Sender: TObject);
begin
  if(btnInserir.Enabled)then
    btnInserir.Click;
end;

procedure TfrmClientes.E1Click(Sender: TObject);
begin
  if(btnEditar.Enabled)then
    btnEditar.Click;
end;

procedure TfrmClientes.E2Click(Sender: TObject);
begin
  if(btnExcluir.Enabled)then
    btnExcluir.Click;
end;

procedure TfrmClientes.B1Click(Sender: TObject);
begin
  if(btnBuscarCNPJ.Enabled)then
    btnBuscarCNPJ.Click;
end;

procedure TfrmClientes.S1Click(Sender: TObject);
begin
  if(btnSair.Enabled)then
    btnSair.Click;
end;

procedure TfrmClientes.btn1Click(Sender: TObject);
var
  SaveDialogCSV: TSaveDialog;
  lArquivoCSV: TStringList;
begin
  SaveDialogCSV := TSaveDialog.Create(Self);
  lArquivoCSV := TStringList.Create;
  try
    SaveDialogCSV.Filter := '*.csv|*.csv';
    SaveDialogCSV.Execute;
    if(SaveDialogCSV.FileName <> '')then
    begin
      lArquivoCSV.Add('ID;Nome;Documento;Email;Telefone;Data de Cadastro');
      if(FConexao = 'Zeos')then
      begin
        DM.TCliente.First;
        while not(DM.TCliente.Eof)do
        begin
          lArquivoCSV.Add(DM.TClienteID.AsString+';'+DM.TClienteNOME.AsString+
          ';'+DM.TClienteDOCUMENTO.AsString+';'+DM.TClienteEMAIL.AsString+';'+
          DM.TClienteTELEFONE.AsString+';'+DM.TClienteDATACADASTRO.AsString);

          DM.TCliente.Next;
        end;
      end else
      begin
        DM.TBCliente.First;
        while not(DM.TBCliente.Eof)do
        begin
          lArquivoCSV.Add(DM.TBClienteID.AsString+';'+DM.TBClienteNOME.AsString+
          ';'+DM.TBClienteDOCUMENTO.AsString+';'+DM.TBClienteEMAIL.AsString+';'+
          DM.TBClienteTELEFONE.AsString+';'+DM.TBClienteDATACADASTRO.AsString);

          DM.TBCliente.Next;
        end;
      end;
      lArquivoCSV.SaveToFile(SaveDialogCSV.FileName);
    end;
  finally
    SaveDialogCSV.Free;
    lArquivoCSV.Free;
  end;
end;

end.
